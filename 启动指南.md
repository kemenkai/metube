# MeTube 项目启动指南

## 环境要求

### 系统要求
- **操作系统**: macOS / Linux / Windows
- **Python**: 3.13+ 
- **Node.js**: 18.20+
- **npm**: 10.8+

### 工具依赖
- **pipenv**: Python 包管理工具
- **Angular CLI**: 前端构建工具

## 快速启动

### 1. 环境准备

#### 安装 Python 依赖管理工具
```bash
# macOS (推荐使用 Homebrew)
brew install pipenv

# 其他系统
pip install pipenv
```

#### 验证环境
```bash
python3 --version  # 应显示 3.13+
node --version     # 应显示 18.20+
npm --version      # 应显示 10.8+
```

### 2. 项目初始化

#### 克隆项目并进入目录
```bash
cd /path/to/metube
```

#### 安装后端依赖
```bash
# 安装 Python 依赖
pipenv install --dev

# 验证环境
pipenv check
```

#### 安装前端依赖
```bash
cd ui
npm install
```

### 3. 启动项目

#### 方法一: 开发模式 (推荐)

**终端 1 - 启动后端服务**
```bash
# 在项目根目录
pipenv run python app/main.py
```
- 后端服务地址: http://localhost:8081
- 支持热重载和 WebSocket 连接

**终端 2 - 启动前端开发服务器**
```bash
# 在 ui/ 目录
cd ui
npm start
# 或者
npx ng serve
```
- 前端开发服务器: http://localhost:4200
- 支持热重载和实时更新

#### 方法二: 生产模式

**构建前端**
```bash
cd ui
npm run build
```

**启动后端 (包含前端)**
```bash
pipenv run python app/main.py
```
- 访问地址: http://localhost:8081

## 项目结构

```
metube/
├── app/                    # Python 后端
│   ├── main.py            # 主服务器文件
│   ├── ytdl.py            # 下载队列管理
│   └── special_downloads.py # 特殊网站处理
├── ui/                     # Angular 前端
│   ├── src/               # 前端源码
│   ├── dist/              # 构建输出
│   └── package.json       # 前端依赖
├── yt_dlp_plugins/        # 自定义插件
├── Pipfile                # Python 依赖
└── docker-entrypoint.sh   # Docker 启动脚本
```

## 常用命令

### 开发命令
```bash
# 后端开发
pipenv shell                    # 激活虚拟环境
pipenv run python app/main.py  # 启动后端服务
pipenv check                    # 检查依赖安全性

# 前端开发
cd ui
npm start                       # 启动开发服务器
npm run build                   # 构建生产版本
npm test                        # 运行测试
npm run lint                    # 代码检查
```

### 测试命令
```bash
# 后端测试
pipenv run python -m pytest    # 运行后端测试

# 前端测试  
cd ui
npm test                        # 运行单元测试
npm run e2e                     # 运行端到端测试

# 自动化测试
node test/playwright-test.js    # 运行浏览器自动化测试
```

## 配置说明

### 环境变量配置
```bash
# 可选的环境变量配置
export DOWNLOAD_DIR="/path/to/downloads"     # 下载目录
export PORT=8081                             # 服务端口
export LOGLEVEL=INFO                         # 日志级别
export YTDL_PLUGINS_DIR="./yt_dlp_plugins"  # 插件目录
```

### 开发环境配置
在开发模式下，前端会自动代理 API 请求到后端:
- 前端: http://localhost:4200
- 后端 API: http://localhost:8081
- WebSocket: ws://localhost:8081/socket.io

## 故障排除

### 常见问题

#### 1. 端口冲突
```bash
# 检查端口占用
lsof -i :8081
lsof -i :4200

# 杀死占用进程
kill -9 <PID>
```

#### 2. 依赖问题
```bash
# 重新安装后端依赖
pipenv clean
pipenv install --dev

# 重新安装前端依赖
cd ui
rm -rf node_modules package-lock.json
npm install
```

#### 3. 权限问题
```bash
# 确保下载目录有写权限
sudo chown -R $USER:$USER /path/to/downloads
chmod 755 /path/to/downloads
```

#### 4. Python 版本问题
```bash
# 检查 Python 版本
python3 --version

# 如果版本不匹配，更新 Pipfile 中的 python_version
```

## 生产部署

### Docker 部署 (推荐)
```bash
# 构建镜像
docker build -t metube .

# 运行容器
docker run -d -p 8081:8081 -v /path/to/downloads:/downloads metube
```

### 手动部署
```bash
# 1. 构建前端
cd ui && npm run build

# 2. 安装生产依赖
pipenv install --deploy

# 3. 启动服务
pipenv run python app/main.py
```

## 开发提示

1. **热重载**: 开发模式下，前后端都支持热重载
2. **调试**: 使用浏览器开发者工具查看网络请求和 WebSocket 连接
3. **日志**: 后端日志会实时显示在终端中
4. **测试**: 建议在每次修改后运行自动化测试

## 支持的功能

- ✅ YouTube 和其他主流视频网站下载
- ✅ 自定义网站插件支持 (tingdao.org, fuyin.tv)
- ✅ 实时下载进度显示
- ✅ 多种质量和格式选择
- ✅ 播放列表支持
- ✅ WebSocket 实时更新
- ✅ Docker 容器化部署

---

**快速启动命令总结:**
```bash
# 终端 1 - 后端
pipenv run python app/main.py

# 终端 2 - 前端  
cd ui && npm start

# 访问: http://localhost:4200
```